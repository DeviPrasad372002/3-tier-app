pipeline {
    agent any

    environment {
        DOCKERHUB_REPO = "deviprasad3722/frontend-image"   // DockerHub repo for frontend
        IMAGE_NAME     = "frontend"

        GIT_CRED_ID    = "github-creds"       // Jenkins GitHub PAT/SSH credentials
        DOCKERHUB_CRED = "dockerhub-creds"    // Jenkins DockerHub credentials
    }

    options {
        timestamps()
    }

    stages {
        stage('Checkout Repo') {
            steps {
                git branch: 'main',
                    credentialsId: "${GIT_CRED_ID}",
                    url: 'https://github.com/DeviPrasad372002/3-tier-app.git'
            }
        }

        stage('Login to DockerHub') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CRED}",
                                                  usernameVariable: 'DOCKER_USER',
                                                  passwordVariable: 'DOCKER_PSW')]) {
                    sh '''
                        echo $DOCKER_PSW | docker login -u $DOCKER_USER --password-stdin
                    '''
                }
            }
        }

        stage('Build & Push Frontend Image') {
            steps {
                dir('frontend') {
                    script {
                        def imageTag = "${DOCKERHUB_REPO}:${BUILD_NUMBER}"
                        sh """
                            docker build -t ${imageTag} .
                            docker push ${imageTag}
                            docker tag ${imageTag} ${DOCKERHUB_REPO}:latest
                            docker push ${DOCKERHUB_REPO}:latest
                            docker system prune -f
                        """
                        env.FRONTEND_TAG = imageTag
                    }
                }
            }
        }

        stage('Deploy to Minikube') {
            steps {
                dir('configuration-files') {
                    script {
                        sh """
                            kubectl config use-context minikube
                            
                            # update deployment image if exists
                            kubectl set image deployment/frontend frontend-container=${FRONTEND_TAG} --record || true

                            # apply manifest (initial deploy or updates)
                            kubectl apply -f deployment-frontend.yaml || true

                            kubectl rollout status deployment/frontend --timeout=120s
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Frontend image built, pushed to DockerHub & deployed to Minikube."
        }
        failure {
            echo "❌ Frontend pipeline failed"
        }
    }
}
